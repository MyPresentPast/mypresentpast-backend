{
	"info": {
		"_postman_id": "cccc3333-4444-5555-6666-777788889999",
		"name": "ğŸ›ï¸ MyPresentPast - Solicitudes de InstituciÃ³n (PR2 REFACTORIZADO)",
		"description": "ğŸ¯ **SISTEMA DE SOLICITUDES DE INSTITUCIÃ“N - PR2 (REFACTORIZADO)**\n\nğŸ”¥ **FLUJO AUTOMÃTICO SIMPLIFICADO:**\n1. âœ… **PASO 1:** Ejecuta 'Login Usuario Normal' â†’ ObtÃ©n token de usuario NORMAL\n2. âœ… **PASO 2:** Ejecuta 'Create Institution Request' â†’ Sube documento Y crea solicitud en UNA operaciÃ³n\n3. âœ… **PASO 3:** Ejecuta 'Get My Requests' â†’ Ve tus solicitudes\n4. âœ… **PASO 4:** Ejecuta 'Cancel Request' â†’ Cancela solicitud si es PENDING\n\nğŸ‰ **FUNCIONALIDADES REFACTORIZADAS:**\nâ€¢ ğŸ›ï¸ **Solicitudes de instituciÃ³n** para usuarios NORMAL\nâ€¢ ğŸ“„ **Upload integrado** (PDF/JPG/PNG, max 5MB) - IGUAL QUE POSTS\nâ€¢ ğŸ“‹ **GestiÃ³n de solicitudes** (crear, ver, cancelar)\nâ€¢ ğŸ”’ **Validaciones de negocio** (1 solicitud activa por usuario)\nâ€¢ â˜ï¸ **IntegraciÃ³n Cloudinary** automÃ¡tica en creaciÃ³n\nâ€¢ ğŸ”„ **OperaciÃ³n atÃ³mica** - documento + solicitud en un solo endpoint\n\nğŸ› ï¸ **ENDPOINTS INCLUIDOS:**\nâ€¢ ğŸ” Login para obtener token de usuario NORMAL\nâ€¢ ğŸ›ï¸ POST /institution-requests - Crear solicitud CON documento (multipart)\nâ€¢ ğŸ“‹ GET /institution-requests/my - Ver mis solicitudes\nâ€¢ âŒ DELETE /institution-requests/{id} - Cancelar solicitud\nâ€¢ âœ… GET /institution-requests/can-create - Verificar si puede crear\n\nâš¡ **VARIABLES AUTOMÃTICAS:**\nâ€¢ `{{base_url}}` = http://localhost:8081\nâ€¢ `{{normal_token}}` = Token de usuario normal\nâ€¢ `{{request_id}}` = ID de solicitud creada\n\nğŸ“… **Refactorizado:** 13 de Septiembre 2025 - Consistencia con patrÃ³n de Posts\n\nğŸ†• **MEJORAS DEL REFACTOR:**\nâ€¢ âœ… Consistencia con creaciÃ³n de posts (multipart en un endpoint)\nâ€¢ âœ… Menos pasos para el usuario (UX mejorada)\nâ€¢ âœ… OperaciÃ³n atÃ³mica (todo o nada)\nâ€¢ âœ… Manejo de errores simplificado\nâ€¢ âœ… Validaciones integradas en el servicio",
		"schema": "https://schema.getpostman.com/json/collection/v2.0.0/collection.json",
		"_exporter_id": "26570332"
	},
	"item": [
		{
			"name": "ğŸ” Authentication",
			"item": [
				{
					"name": "ğŸ‘¤ Login Usuario Normal",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"// ğŸ”¥ Script automÃ¡tico para guardar token de usuario NORMAL",
									"if (pm.response.code === 200) {",
									"    const responseJson = pm.response.json();",
									"    pm.environment.set('normal_token', responseJson.token);",
									"    console.log('âœ… Login exitoso como usuario NORMAL');",
									"    console.log('ğŸ¯ Token guardado automÃ¡ticamente');",
									"    console.log('ğŸ’¡ Ahora puedes crear solicitudes de instituciÃ³n');",
									"} else {",
									"    console.log('âŒ Error en login:', pm.response.text());",
									"    console.log('ğŸ’¡ Verifica que el usuario existe y la contraseÃ±a es correcta');",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"normal@test.com\",\n  \"password\": \"TestPassword123\"\n}"
						},
						"url": "{{base_url}}/auth/login"
					}
				}
			]
		},
		{
			"name": "ğŸ›ï¸ Institution Requests",
			"item": [
				{
					"name": "âœ… Check Can Create Request",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"// ğŸ”¥ Test para verificar si puede crear solicitud",
									"if (pm.response.code === 200) {",
									"    const canCreate = pm.response.json();",
									"    console.log('âœ… VerificaciÃ³n exitosa');",
									"    if (canCreate) {",
									"        console.log('ğŸ¯ PUEDE crear nueva solicitud');",
									"        console.log('ğŸ’¡ Usuario es NORMAL y no tiene solicitud activa');",
									"    } else {",
									"        console.log('âš ï¸ NO PUEDE crear nueva solicitud');",
									"        console.log('ğŸ’¡ Posibles razones:');",
									"        console.log('   - Usuario no es NORMAL');",
									"        console.log('   - Ya tiene solicitud activa (PENDING/IN_REVIEW/APPROVED)');",
									"    }",
									"} else {",
									"    console.log('âŒ Error al verificar:', pm.response.text());",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{normal_token}}"
							}
						],
						"url": "{{base_url}}/institution-requests/can-create"
					}
				},
				{
					"name": "ğŸ›ï¸ Create Institution Request (WITH Document)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"// ğŸ”¥ Script automÃ¡tico para crear solicitud de instituciÃ³n CON documento",
									"if (pm.response.code === 201) {",
									"    const responseJson = pm.response.json();",
									"    console.log('âœ… Solicitud de instituciÃ³n creada exitosamente');",
									"    console.log('ğŸ“ Mensaje:', responseJson.message);",
									"    console.log('ğŸ¯ Estado inicial: PENDING');",
									"    console.log('ğŸ“„ Documento subido automÃ¡ticamente');",
									"    console.log('ğŸ’¡ Ahora consulta tus solicitudes para ver el ID');",
									"} else if (pm.response.code === 400) {",
									"    const errorMsg = pm.response.json().message;",
									"    console.log('âš ï¸ Error de validaciÃ³n:', errorMsg);",
									"    if (errorMsg.includes('solicitud activa')) {",
									"        console.log('ğŸ’¡ Tip: Ya tienes una solicitud activa. CancÃ©lala primero si es PENDING');",
									"    } else if (errorMsg.includes('documento')) {",
									"        console.log('ğŸ’¡ Tip: Verifica que el documento sea PDF/JPG/PNG y menor a 5MB');",
									"    } else if (errorMsg.includes('mayor a 5MB')) {",
									"        console.log('ğŸ’¡ Tip: El documento es muy grande, usa uno menor a 5MB');",
									"    } else if (errorMsg.includes('no permitido')) {",
									"        console.log('ğŸ’¡ Tip: Solo se permiten archivos PDF, JPG y PNG');",
									"    }",
									"} else if (pm.response.code === 403) {",
									"    console.log('ğŸš« No autorizado - VERIFICA:');",
									"    console.log('   1. Que el token sea de un usuario NORMAL');",
									"    console.log('   2. Que hayas ejecutado el login correctamente');",
									"} else {",
									"    console.log('âŒ Error inesperado:', pm.response.text());",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{normal_token}}"
							}
						],
						"body": {
							"mode": "formdata",
							"formdata": [
								{
									"key": "request",
									"value": "{\n  \"institution_name\": \"Universidad de Ejemplo\",\n  \"legal_address\": \"Av. Universitaria 123, Ciudad Ejemplo, PaÃ­s\",\n  \"official_phone\": \"+1234567890\",\n  \"type\": \"UNIVERSITY\",\n  \"official_registry_number\": \"REG-2024-001\",\n  \"official_website\": \"https://www.universidad-ejemplo.edu\"\n}",
									"type": "text",
									"contentType": "application/json"
								},
								{
									"key": "document",
									"type": "file",
									"src": [],
									"description": "Selecciona un archivo PDF, JPG o PNG (mÃ¡x 5MB)"
								}
							]
						},
						"url": "{{base_url}}/institution-requests"
					}
				},
				{
					"name": "ğŸ“‹ Get My Requests",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"// ğŸ”¥ Test para ver solicitudes del usuario",
									"if (pm.response.code === 200) {",
									"    const requests = pm.response.json();",
									"    console.log('âœ… Solicitudes obtenidas exitosamente');",
									"    console.log('ğŸ“Š Total de solicitudes:', requests.length);",
									"    ",
									"    if (requests.length > 0) {",
									"        // Guardar ID de la primera solicitud para cancelar",
									"        pm.environment.set('request_id', requests[0].id);",
									"        ",
									"        requests.forEach((request, index) => {",
									"            console.log(`\\nğŸ“‹ Solicitud ${index + 1}:`);",
									"            console.log('   ID:', request.id);",
									"            console.log('   InstituciÃ³n:', request.institution_name);",
									"            console.log('   Tipo:', request.type);",
									"            console.log('   Estado:', request.status);",
									"            console.log('   Creada:', request.created_at);",
									"            console.log('   Documento:', request.document_url ? 'âœ… Subido' : 'âŒ Sin documento');",
									"            if (request.reviewed_at) {",
									"                console.log('   Revisada:', request.reviewed_at);",
									"            }",
									"            if (request.rejection_reason) {",
									"                console.log('   Motivo rechazo:', request.rejection_reason);",
									"            }",
									"        });",
									"        ",
									"        console.log('\\nğŸ¯ ID de primera solicitud guardado para cancelar');",
									"    } else {",
									"        console.log('ğŸ“ No tienes solicitudes creadas aÃºn');",
									"    }",
									"} else {",
									"    console.log('âŒ Error al obtener solicitudes:', pm.response.text());",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{normal_token}}"
							}
						],
						"url": "{{base_url}}/institution-requests/my"
					}
				},
				{
					"name": "âŒ Cancel Request",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"// ğŸ”¥ Test para cancelar solicitud",
									"if (pm.response.code === 200) {",
									"    const responseJson = pm.response.json();",
									"    console.log('âœ… Solicitud cancelada exitosamente');",
									"    console.log('ğŸ“ Mensaje:', responseJson.message);",
									"    console.log('ğŸ¯ Estado cambiado a: CANCELLED');",
									"    console.log('ğŸ’¡ Ahora puedes crear una nueva solicitud');",
									"} else if (pm.response.code === 400) {",
									"    const errorMsg = pm.response.json().message;",
									"    console.log('âš ï¸ Error de validaciÃ³n:', errorMsg);",
									"    if (errorMsg.includes('pendientes')) {",
									"        console.log('ğŸ’¡ Tip: Solo se pueden cancelar solicitudes PENDING');",
									"        console.log('ğŸ’¡ Si estÃ¡ IN_REVIEW o APPROVED, no se puede cancelar');",
									"    }",
									"} else if (pm.response.code === 404) {",
									"    console.log('âŒ Solicitud no encontrada');",
									"    console.log('ğŸ’¡ Tip: Verifica que el ID sea correcto y sea tuya');",
									"} else {",
									"    console.log('âŒ Error inesperado:', pm.response.text());",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "DELETE",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{normal_token}}"
							}
						],
						"url": "{{base_url}}/institution-requests/{{request_id}}"
					}
				}
			]
		},
		{
			"name": "ğŸ§ª Test Scenarios",
			"item": [
				{
					"name": "ğŸš« Try Create Request as Institution (Should Fail)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"// ğŸ”¥ Test negativo - instituciÃ³n no puede crear solicitud",
									"if (pm.response.code === 403) {",
									"    console.log('âœ… Test CORRECTO: InstituciÃ³n no puede crear solicitud');",
									"    console.log('ğŸ”’ Seguridad funcionando: Solo usuarios NORMAL pueden solicitar');",
									"} else if (pm.response.code === 400) {",
									"    const errorMsg = pm.response.json().message;",
									"    if (errorMsg.includes('usuarios normales')) {",
									"        console.log('âœ… Test CORRECTO: ValidaciÃ³n de rol funcionando');",
									"    } else {",
									"        console.log('âš ï¸ Error diferente al esperado:', errorMsg);",
									"    }",
									"} else {",
									"    console.log('âŒ Test FALLIDO: DeberÃ­a fallar con 403 o 400');",
									"    console.log('ğŸ“ Respuesta:', pm.response.text());",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{institution_token}}"
							}
						],
						"body": {
							"mode": "formdata",
							"formdata": [
								{
									"key": "request",
									"value": "{\n  \"institution_name\": \"Test Institution\",\n  \"legal_address\": \"Test Address 123\",\n  \"official_phone\": \"+1234567890\",\n  \"type\": \"UNIVERSITY\"\n}",
									"type": "text",
									"contentType": "application/json"
								},
								{
									"key": "document",
									"type": "file",
									"src": []
								}
							]
						},
						"url": "{{base_url}}/institution-requests"
					}
				},
				{
					"name": "ğŸ“„ Try Create Without Document (Should Fail)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"// ğŸ”¥ Test negativo - crear sin documento",
									"if (pm.response.code === 400) {",
									"    const errorMsg = pm.response.json().message;",
									"    console.log('âœ… Test CORRECTO: Crear sin documento falla');",
									"    console.log('ğŸ”’ ValidaciÃ³n funcionando:', errorMsg);",
									"    if (errorMsg.includes('documento es requerido')) {",
									"        console.log('ğŸ’¡ ValidaciÃ³n especÃ­fica: Documento requerido');",
									"    }",
									"} else {",
									"    console.log('âŒ Test FALLIDO: DeberÃ­a fallar con 400');",
									"    console.log('ğŸ“ Respuesta:', pm.response.text());",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{normal_token}}"
							}
						],
						"body": {
							"mode": "formdata",
							"formdata": [
								{
									"key": "request",
									"value": "{\n  \"institution_name\": \"Test Institution\",\n  \"legal_address\": \"Test Address 123\",\n  \"official_phone\": \"+1234567890\",\n  \"type\": \"UNIVERSITY\"\n}",
									"type": "text",
									"contentType": "application/json"
								}
							]
						},
						"url": "{{base_url}}/institution-requests"
					}
				}
			]
		}
	],
	"variable": [
		{
			"key": "base_url",
			"value": "http://localhost:8081"
		},
		{
			"key": "normal_token",
			"value": ""
		},
		{
			"key": "institution_token",
			"value": ""
		},
		{
			"key": "request_id",
			"value": ""
		}
	]
}
